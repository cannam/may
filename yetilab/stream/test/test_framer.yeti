
module yetilab.stream.test.test_framer;

fr = load yetilab.stream.framer;
vec = load yetilab.vector;
mat = load yetilab.matrix;
syn = load yetilab.stream.syntheticstream;

{ compare, compareUsing } = load yetilab.test.test;

rate = 10;

testStream n is number -> 'a  = syn.precalculated rate (vec.fromList [1..n]);

compareFrames frames1 frames2 =
    all id (map2 do f1 f2: compareUsing mat.equal f1 f2 done frames1
       (map (mat.newRowVector . vec.fromList) frames2));

testFrames parameters length expected =
   (f = fr.frames parameters (testStream length);
    str = fr.streamed rate parameters f;
    sz = parameters.framesize;
    ts = testStream length;
    compareFrames f expected and
        compareUsing mat.equal
           (str.read length) (ts.read length) and
        compare str.position length and
        compare str.available (Known (sz - (length % sz))));
/*
        compareUsing mat.equal
           (str.read 2) (ts.read 2) and
        compareUsing mat.equal
           (str.read (length - 2)) (ts.read (length - 2)) and
        compare str.position length and
        compare str.available (Known (sz - (length % sz))));
*/
[

"framecount-2x2": \( 
    fr = fr.frames { framesize = 2, hop = 2 } (testStream 2);
    compare (length fr) 1
),

"framecount-2x3": \( 
    fr = fr.frames { framesize = 2, hop = 2 } (testStream 3);
    compare (length fr) 2
),

"framecount-2x4": \( 
    fr = fr.frames { framesize = 2, hop = 2 } (testStream 4);
    compare (length fr) 2
),

"framecount-2.1x0": \( 
    fr = fr.frames { framesize = 2, hop = 1 } (testStream 0);
    compare (length fr) 1
),

"framecount-2.1x1": \( 
    fr = fr.frames { framesize = 2, hop = 1 } (testStream 1);
    compare (length fr) 2
),

"framecount-2.1x2": \( 
    fr = fr.frames { framesize = 2, hop = 1 } (testStream 2);
    compare (length fr) 3
),

"framecount-2.1x3": \( 
    fr = fr.frames { framesize = 2, hop = 1 } (testStream 3);
    compare (length fr) 4
),

"framecount-4.1x4": \( 
    fr = fr.frames { framesize = 4, hop = 1 } (testStream 4);
    compare (length fr) 7
),

"framecount-4.3x4": \( 
    fr = fr.frames { framesize = 4, hop = 3 } (testStream 4);
    compare (length fr) 2 
),

"framecount-4.4x4": \( 
    fr = fr.frames { framesize = 4, hop = 4 } (testStream 4);
    compare (length fr) 1
),

"framecount-3.2x4": \(
    fr = fr.frames { framesize = 3, hop = 2 } (testStream 4);
    compare (length fr) 3
),

"frames-2x5": \( 
    testFrames { framesize = 2, hop = 2 } 5 [ [1,2], [3,4], [5,0] ];
),

"frames-4.3x4": \( 
    testFrames { framesize = 4, hop = 3 } 4 [ [0,1,2,3], [3,4,0,0] ];
),

"frames-3.2x4": \(
    testFrames { framesize = 3, hop = 2 } 4 [ [0,1,2], [2,3,4], [4,0,0] ];
),

"frames-3.1x6": \(
    testFrames { framesize = 3, hop = 1 } 6
        [ [0,0,1], [0,1,2], [1,2,3], [2,3,4],
          [3,4,5], [4,5,6], [5,6,0], [6,0,0] ];
),

"frames-4.2x8": \(
    testFrames { framesize = 4, hop = 2 } 8
        [ [0,0,1,2], [1,2,3,4], [3,4,5,6], [5,6,7,8], [7,8,0,0] ];
),

"overlapAdd-3.1": \(
    compareUsing (mat.equal)
       (fr.overlapAdd 1 3 1 [ mat.newRowVector (vec.fromList [ 1,2,3 ]),
                              mat.newRowVector (vec.fromList [   4,5,6 ]),
                              mat.newRowVector (vec.fromList [     7,8,9 ]) ])
       (mat.newRowVector (vec.fromList [ 1,6,15,14,9 ]))
),

"overlapAdd-3.2": \(
    compareUsing (mat.equal)
       (fr.overlapAdd 1 3 2 [ mat.newRowVector (vec.fromList [ 1,2,3 ]),
                              mat.newRowVector (vec.fromList [     4,5,6 ]),
                              mat.newRowVector (vec.fromList [         7,8,9 ]) ])
       (mat.newRowVector (vec.fromList [ 1,2,7,5,13,8,9 ]))
),

] is hash<string, () -> boolean>;



