
module yetilab.stream.test.test_filter;

bl = load yetilab.block.block;
mat = load yetilab.matrix.matrix;
syn = load yetilab.stream.syntheticstream;
filt = load yetilab.stream.filter;

{ compare, compareUsing } = load yetilab.test.test;

[

"truncatedTo": \(
    str = filt.truncatedTo 3 (syn.generated 2 id);
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Known 3) and
        compare str.finished? false and
        compare (bl.list ((str.read 4).getRow 0)) [ 0,1,2 ] and
        compare str.position 3 and
        compare str.available (Known 0) and
        compare str.finished? true and
        ( str.close (); true )
),

"extendedTo": \(
    str = filt.truncatedTo 5 (filt.truncatedTo 3 (syn.generated 2 id));
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Known 5) and
        compare str.finished? false and
        compare (bl.list ((str.read 4).getRow 0)) [ 0,1,2,0 ] and
        compare str.position 4 and
        compare str.available (Known 1) and
        compare str.finished? false and
        compare (bl.list ((str.read 2).getRow 0)) [ 0,0 ] and
        compare str.position 5 and
        compare str.available (Known 0) and
        compare str.finished? true and
        ( str.close (); true )
),

"delayedBy-0-3": \(
    str = filt.delayedBy 0 (filt.truncatedTo 3 (syn.generated 2 id));
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Known 3) and
        compare str.finished? false and
        compare (bl.list ((str.read 4).getRow 0)) [ 0,1,2 ] and
        compare str.position 3 and
        compare str.available (Known 0) and
        compare str.finished? true and
        ( str.close (); true )
),

"delayedBy-0-inf": \(
    str = filt.delayedBy 0 (syn.generated 2 id);
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Infinite ()) and
        compare str.finished? false and
        compare (bl.list ((str.read 4).getRow 0)) [ 0,1,2,3 ] and
        compare str.position 4 and
        compare str.available (Infinite ()) and
        compare str.finished? false and
        ( str.close (); true )
),

"delayedBy-2-3": \(
    str = filt.delayedBy 2 (filt.truncatedTo 3 (syn.generated 2 id));
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Known 5) and
        compare str.finished? false and
        compare (bl.list ((str.read 4).getRow 0)) [ 0,0,0,1 ] and
        compare str.position 4 and
        compare str.available (Known 1) and
        compare str.finished? false and
        compare (bl.list ((str.read 4).getRow 0)) [ 2 ] and
        compare str.position 5 and
        compare str.available (Known 0) and
        compare str.finished? true and
        ( str.close (); true )
),

"delayedBy-2-3b": \(
    str = filt.delayedBy 2 (filt.truncatedTo 3 (syn.generated 2 id));
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Known 5) and
        compare str.finished? false and
        compare (bl.list ((str.read 1).getRow 0)) [ 0 ] and
        compare str.position 1 and
        compare str.available (Known 4) and
        compare str.finished? false and
        compare (bl.list ((str.read 4).getRow 0)) [ 0,0,1,2 ] and
        compare str.position 5 and
        compare str.available (Known 0) and
        compare str.finished? true and
        ( str.close (); true )
),

"delayedBy-2-3c": \(
    str = filt.delayedBy 2 (filt.truncatedTo 3 (syn.generated 2 id));
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Known 5) and
        compare str.finished? false and
        compare (bl.list ((str.read 7).getRow 0)) [ 0,0,0,1,2 ] and
        compare str.position 5 and
        compare str.available (Known 0) and
        compare str.finished? true and
        ( str.close (); true )
),

"delayedBy-2-inf": \(
    str = filt.delayedBy 2 (syn.generated 2 id);
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Infinite ()) and
        compare str.finished? false and
        compare (bl.list ((str.read 2).getRow 0)) [ 0,0 ] and
        compare str.position 2 and
        compare str.finished? false and
        compare (bl.list ((str.read 2).getRow 0)) [ 0,1 ] and
        compare str.position 4 and
        compare str.finished? false and
        compare (bl.list ((str.read 2).getRow 0)) [ 2,3 ] and
        compare str.position 6 and
        compare str.finished? false and
        ( str.close (); true )
),

"multiplexed-inf-inf": \(
    str = filt.multiplexed [syn.generated 2 id, syn.generated 2 (0-)];
    compare str.position 0 and
        compare str.channels 2 and
        compare str.sampleRate 2 and
        compare str.available (Infinite ()) and
        compare str.finished? false and
        compare (map bl.list (mat.asRows (str.read 4)))
            [[0,1,2,3], [0,-1,-2,-3]] and
        compare str.available (Infinite ()) and
        compare str.position 4 and
        ( str.close (); true )
),

"multiplexed-inf-trunc": \(
    str = filt.multiplexed [syn.generated 2 id, filt.truncatedTo 3 (syn.generated 2 (0-))];
    compare str.position 0 and
        compare str.channels 2 and
        compare str.sampleRate 2 and
        compare str.available (Known 3) and
        compare str.finished? false and
        compare (map bl.list (mat.asRows (str.read 4))) [[0,1,2], [0,-1,-2]] and
        compare str.available (Known 0) and
        compare str.finished? true and
        compare str.position 3 and
        ( str.close (); true )
),

"multiplexed-precalc-trunc": \(
    str = filt.multiplexed
       [syn.precalculated 2 (bl.fromList [1,2]),
        filt.truncatedTo 3 (syn.generated 2 (0-))];
    compare str.position 0 and
        compare str.channels 2 and
        compare str.sampleRate 2 and
        compare str.available (Known 2) and
        compare str.finished? false and
        compare (map bl.list (mat.asRows (str.read 4))) [[1,2], [0,-1]] and
        compare str.available (Known 0) and
        compare str.finished? true and
        compare str.position 2 and
        ( str.close (); true )
),

"multiplexed-2-1": \(
    str = filt.multiplexed
       [syn.precalculated 2 (bl.fromList [1,2]),
        filt.multiplexed [syn.precalculated 2 (bl.fromList [3,4]),
                          filt.truncatedTo 3 (syn.generated 2 (0-))]];
    compare str.position 0 and
        compare str.channels 3 and
        compare str.sampleRate 2 and
        compare str.available (Known 2) and
        compare str.finished? false and
        compare (map bl.list (mat.asRows (str.read 4))) [[1,2], [3,4], [0,-1]] and
        compare str.available (Known 0) and
        compare str.finished? true and
        compare str.position 2 and
        ( str.close (); true )
),

"multiplexed-2-1b": \(
    str = filt.multiplexed
       [syn.precalculated 2 (bl.fromList [1,2]),
        syn.precalculated 2 (bl.fromList [3,4]),
        filt.truncatedTo 3 (syn.generated 2 (0-))];
    compare str.position 0 and
        compare str.channels 3 and
        compare str.sampleRate 2 and
        compare str.available (Known 2) and
        compare str.finished? false and
        compare (map bl.list (mat.asRows (str.read 4))) [[1,2], [3,4], [0,-1]] and
        compare str.available (Known 0) and
        compare str.finished? true and
        compare str.position 2 and
        ( str.close (); true )
),

"repeated-2": \(
    str = filt.repeated
       (syn.precalculated 2 (bl.fromList [1,2,3]));
    compare str.position 0 and
        compare str.channels 1 and
        compare str.sampleRate 2 and
        compare str.available (Infinite ()) and
        compare str.finished? false and
        compare (map bl.list (mat.asRows (str.read 1))) [[1]] and
        compare str.position 1 and
        compare (map bl.list (mat.asRows (str.read 2))) [[2,3]] and
        compare str.position 3 and
        compare (map bl.list (mat.asRows (str.read 3))) [[1,2,3]] and
        compare str.position 6 and
        compare (map bl.list (mat.asRows (str.read 5))) [[1,2,3,1,2]] and
        compare (map bl.list (mat.asRows (str.read 9))) [[3,1,2,3,1,2,3,1,2]] and
        compare (map bl.list (mat.asRows (str.read 2))) [[3,1]] and
        compare str.available (Infinite ()) and
        compare str.finished? false and
        compare str.position 22 and
        ( str.close (); true )
),

//!!! still no tests for filters with multi-channel inputs

] is hash<string, () -> boolean>

